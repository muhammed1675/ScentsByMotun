<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Admin Dashboard - ScentsBymotun" />
    <title>Admin Dashboard - ScentsBymotun</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://js.paystack.co/v1/inline.js"></script>
  </head>
  <body>
    <!-- Header & Navigation -->
    <header>
      <div class="container">
        <nav class="flex justify-between items-center">
          <a href="../index.html" class="logo">ScentsBymotun</a>

          <ul class="nav-menu">
            <li><a href="../index.html">Home</a></li>
            <li><a href="shop.html">Shop</a></li>
          </ul>

          <div class="nav-actions">
            <button class="user-icon" id="user-menu-btn" title="Account">ðŸ‘¤</button>
          </div>
        </nav>
      </div>
    </header>

    <!-- User Menu -->
    <div id="user-menu" class="modal">
      <div class="modal-content" style="max-width: 300px">
        <div class="modal-header">
          <h3 class="modal-title">Account</h3>
          <button class="modal-close" onclick="closeUserMenu()">âœ•</button>
        </div>
        <div id="auth-menu"></div>
      </div>
    </div>

    <!-- Main Content -->
    <main>
      <!-- Admin Header -->
      <section style="background-color: var(--primary); color: var(--text-light); padding: 2rem 0">
        <div class="container">
          <h1>Admin Dashboard</h1>
          <p>Manage your ScentsBymotun store</p>
        </div>
      </section>

      <!-- Dashboard Stats -->
      <section style="background-color: var(--bg-secondary); padding: 2rem 0">
        <div class="container">
          <div class="grid grid-cols-4 gap-4">
            <div class="card p-4 text-center">
              <p style="color: var(--text-secondary); margin-bottom: 0.5rem">Total Orders</p>
              <p style="font-size: 2rem; font-weight: 700; margin: 0" id="total-orders">0</p>
            </div>

            <div class="card p-4 text-center">
              <p style="color: var(--text-secondary); margin-bottom: 0.5rem">Paid Orders</p>
              <p style="font-size: 2rem; font-weight: 700; color: #388e3c; margin: 0" id="paid-orders">0</p>
            </div>

            <div class="card p-4 text-center">
              <p style="color: var(--text-secondary); margin-bottom: 0.5rem">Pending Orders</p>
              <p style="font-size: 2rem; font-weight: 700; color: var(--secondary); margin: 0" id="pending-orders">0</p>
            </div>

            <div class="card p-4 text-center">
              <p style="color: var(--text-secondary); margin-bottom: 0.5rem">Total Revenue</p>
              <p style="font-size: 1.5rem; font-weight: 700; margin: 0" id="total-revenue">â‚¦0</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Admin Tabs -->
      <section>
        <div class="container">
          <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color)">
            <button
              class="tab-btn active"
              onclick="switchTab('orders')"
              style="padding: 1rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent"
            >
              Orders
            </button>
            <button
              class="tab-btn"
              onclick="switchTab('products')"
              style="padding: 1rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent"
            >
              Products
            </button>
          </div>

          <!-- Orders Tab -->
          <div id="orders-tab" class="tab-content">
            <h2 style="margin-bottom: 1.5rem">Recent Orders</h2>

            <div class="card">
              <div style="overflow-x: auto">
                <table style="width: 100%; border-collapse: collapse">
                  <thead>
                    <tr style="border-bottom: 2px solid var(--border-color)">
                      <th style="padding: 1rem; text-align: left">Order ID</th>
                      <th style="padding: 1rem; text-align: left">Customer</th>
                      <th style="padding: 1rem; text-align: left">Amount</th>
                      <th style="padding: 1rem; text-align: left">Status</th>
                      <th style="padding: 1rem; text-align: left">Date</th>
                      <th style="padding: 1rem; text-align: left">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="orders-table">
                    <tr>
                      <td style="padding: 1rem" colspan="6">
                        <div style="text-align: center; padding: 2rem">
                          <p>Loading orders...</p>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Products Tab -->
          <div id="products-tab" class="tab-content" style="display: none">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem">
              <h2>Product Management</h2>
              <button class="btn btn-gold" onclick="openProductModal()">+ Add New Product</button>
            </div>

            <div class="grid grid-cols-3 gap-4" id="products-grid">
              <div style="grid-column: 1 / -1; text-align: center; padding: 2rem">
                <p>Loading products...</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Order Status Modal -->
    <div id="order-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Update Order Status</h3>
          <button class="modal-close" onclick="closeOrderModal()">âœ•</button>
        </div>

        <div id="order-modal-content">
          <!-- Will be populated -->
        </div>
      </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h3 class="modal-title">Add / Edit Product</h3>
          <button class="modal-close" onclick="closeProductModal()">âœ•</button>
        </div>

        <form id="product-form">
          <div class="form-group">
            <label for="product-name">Product Name</label>
            <input type="text" id="product-name" required />
          </div>

          <div class="form-group">
            <label for="product-price">Price (NGN)</label>
            <input type="number" id="product-price" required min="0" step="0.01" />
          </div>

          <div class="form-group">
            <label for="product-category">Category</label>
            <select id="product-category" required>
              <option value="">Select Category</option>
              <option value="Men">Men</option>
              <option value="Women">Women</option>
              <option value="Unisex">Unisex</option>
            </select>
          </div>

          <div class="form-group">
            <label for="product-description">Description</label>
            <textarea id="product-description"></textarea>
          </div>

          <div class="form-group">
            <label for="product-scent">Scent Notes</label>
            <textarea id="product-scent" placeholder="e.g., Top: Bergamot, Heart: Rose, Base: Musk"></textarea>
          </div>

          <div class="form-group">
            <label for="product-image">Image URL</label>
            <input type="url" id="product-image" />
          </div>

          <button type="submit" class="btn btn-gold btn-block">Save Product</button>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer style="margin-top: 4rem">
      <div class="container">
        <div class="footer-bottom">
          <p>&copy; 2024 ScentsBymotun. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script type="module">
      import { auth } from '../js/auth.js';
      import { checkout } from '../js/checkout.js';
      import { products } from '../js/products.js';

      // [v0] Initialize admin dashboard
      console.log('[v0] Admin dashboard initializing');

      // Check admin access
      if (!auth.isUserAdmin()) {
        window.location.href = '../index.html';
      }

      let allOrders = [];
      let allProducts = [];

      // Load dashboard stats
      async function loadDashboardStats() {
        try {
          const orders = await checkout.getAllOrders();
          allOrders = orders;

          const totalOrders = orders.length;
          const paidOrders = orders.filter((o) => o.status === 'paid').length;
          const pendingOrders = orders.filter((o) => o.status === 'pending').length;
          const totalRevenue = orders
            .filter((o) => o.status === 'paid')
            .reduce((sum, o) => sum + (o.total_amount || 0), 0);

          document.getElementById('total-orders').textContent = totalOrders;
          document.getElementById('paid-orders').textContent = paidOrders;
          document.getElementById('pending-orders').textContent = pendingOrders;
          document.getElementById('total-revenue').textContent = 'â‚¦' + totalRevenue.toLocaleString();

          renderOrders();
        } catch (error) {
          console.error('[v0] Error loading stats:', error);
        }
      }

      // Render orders table
      function renderOrders() {
        const tbody = document.getElementById('orders-table');

        if (allOrders.length === 0) {
          tbody.innerHTML =
            '<tr><td style="padding: 1rem" colspan="6"><div style="text-align: center; padding: 2rem"><p>No orders yet.</p></div></td></tr>';
          return;
        }

        tbody.innerHTML = allOrders
          .slice(0, 10)
          .map(
            (order) => `
          <tr style="border-bottom: 1px solid var(--border-color)">
            <td style="padding: 1rem"><code>${order.id.substring(0, 8)}</code></td>
            <td style="padding: 1rem">${order.user_id ? order.user_id.substring(0, 8) : 'N/A'}</td>
            <td style="padding: 1rem">â‚¦${order.total_amount.toLocaleString()}</td>
            <td style="padding: 1rem">
              <span class="badge ${getStatusBadgeClass(order.status)}">${order.status}</span>
            </td>
            <td style="padding: 1rem">${new Date(order.created_at).toLocaleDateString()}</td>
            <td style="padding: 1rem">
              <button class="btn btn-sm btn-secondary" onclick="openOrderModal('${order.id}')">Edit</button>
            </td>
          </tr>
        `
          )
          .join('');
      }

      // Get status badge class
      function getStatusBadgeClass(status) {
        const classes = {
          pending: 'badge-primary',
          paid: 'badge-gold',
          processing: 'badge-primary',
          shipped: 'badge-primary',
          delivered: 'badge-gold',
          failed: 'badge-primary',
        };
        return classes[status] || 'badge-primary';
      }

      // Open order modal
      window.openOrderModal = async (orderId) => {
        const order = allOrders.find((o) => o.id === orderId);
        if (!order) return;

        const content = document.getElementById('order-modal-content');
        content.innerHTML = `
          <div class="form-group">
            <label for="order-status">Status</label>
            <select id="order-status">
              <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>Paid</option>
              <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
              <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
              <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
              <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </div>

          <p style="color: var(--text-secondary); margin-bottom: 1rem">Order Amount: <strong>â‚¦${order.total_amount.toLocaleString()}</strong></p>

          <button class="btn btn-gold btn-block" onclick="updateOrderStatus('${orderId}')">Update Status</button>
          <button class="btn btn-secondary btn-block mt-2" onclick="closeOrderModal()">Cancel</button>
        `;

        document.getElementById('order-modal').classList.add('active');
      };

      // Update order status
      window.updateOrderStatus = async (orderId) => {
        const status = document.getElementById('order-status').value;
        try {
          await checkout.updateOrderStatus(orderId, status);
          closeOrderModal();
          loadDashboardStats();
          alert('Order status updated successfully!');
        } catch (error) {
          alert('Error updating order: ' + error.message);
        }
      };

      // Close order modal
      window.closeOrderModal = () => {
        document.getElementById('order-modal').classList.remove('active');
      };

      // Load products
      async function loadProducts() {
        try {
          allProducts = await products.getAllProducts();
          renderProducts();
        } catch (error) {
          console.error('[v0] Error loading products:', error);
        }
      }

      // Render products grid
      function renderProducts() {
        const grid = document.getElementById('products-grid');

        if (allProducts.length === 0) {
          grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center"><p>No products yet.</p></div>';
          return;
        }

        grid.innerHTML = allProducts
          .map(
            (product) => `
          <div class="product-card">
            <img src="${product.image_url}" alt="${product.name}" class="product-image" onerror="this.src='https://via.placeholder.com/300x300?text=${encodeURIComponent(product.name)}'">
            <div class="product-content">
              <div class="product-category">${product.category}</div>
              <h3 class="product-name">${product.name}</h3>
              <div class="product-price">â‚¦${product.price.toLocaleString()}</div>
              <button class="btn btn-sm btn-secondary btn-block mb-2" onclick="editProduct('${product.id}')">Edit</button>
              <button class="btn btn-sm btn-secondary btn-block" onclick="deleteProduct('${product.id}')">Delete</button>
            </div>
          </div>
        `
          )
          .join('');
      }

      // Open product modal
      window.openProductModal = () => {
        document.getElementById('product-form').reset();
        document.getElementById('product-form').onsubmit = async (e) => {
          e.preventDefault();

          const productData = {
            name: document.getElementById('product-name').value,
            price: parseFloat(document.getElementById('product-price').value),
            category: document.getElementById('product-category').value,
            description: document.getElementById('product-description').value,
            scent_notes: document.getElementById('product-scent').value,
            image_url: document.getElementById('product-image').value,
          };

          try {
            await products.createProduct(productData);
            closeProductModal();
            loadProducts();
            alert('Product created successfully!');
          } catch (error) {
            alert('Error creating product: ' + error.message);
          }
        };

        document.getElementById('product-modal').classList.add('active');
      };

      // Close product modal
      window.closeProductModal = () => {
        document.getElementById('product-modal').classList.remove('active');
      };

      // Edit product
      window.editProduct = (productId) => {
        const product = allProducts.find((p) => p.id === productId);
        if (!product) return;

        document.getElementById('product-name').value = product.name;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-category').value = product.category;
        document.getElementById('product-description').value = product.description;
        document.getElementById('product-scent').value = product.scent_notes || '';
        document.getElementById('product-image').value = product.image_url;

        document.getElementById('product-form').onsubmit = async (e) => {
          e.preventDefault();

          const productData = {
            name: document.getElementById('product-name').value,
            price: parseFloat(document.getElementById('product-price').value),
            category: document.getElementById('product-category').value,
            description: document.getElementById('product-description').value,
            scent_notes: document.getElementById('product-scent').value,
            image_url: document.getElementById('product-image').value,
          };

          try {
            await products.updateProduct(productId, productData);
            closeProductModal();
            loadProducts();
            alert('Product updated successfully!');
          } catch (error) {
            alert('Error updating product: ' + error.message);
          }
        };

        document.getElementById('product-modal').classList.add('active');
      };

      // Delete product
      window.deleteProduct = async (productId) => {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
          await products.deleteProduct(productId);
          loadProducts();
          alert('Product deleted successfully!');
        } catch (error) {
          alert('Error deleting product: ' + error.message);
        }
      };

      // Switch tabs
      window.switchTab = (tabName) => {
        document.querySelectorAll('.tab-btn').forEach((btn) => {
          btn.classList.remove('active');
          btn.style.borderBottomColor = 'transparent';
        });

        document.querySelectorAll('.tab-content').forEach((tab) => {
          tab.style.display = 'none';
        });

        event.target.classList.add('active');
        event.target.style.borderBottomColor = 'var(--secondary)';
        document.getElementById(tabName + '-tab').style.display = 'block';

        if (tabName === 'products' && allProducts.length === 0) {
          loadProducts();
        }
      };

      // Update auth menu
      function updateAuthMenu() {
        const menu = document.getElementById('auth-menu');
        menu.innerHTML = `
          <p style="margin-bottom: var(--spacing-md)">Welcome, <strong>${auth.getUser().email}</strong></p>
          <button class="btn btn-primary btn-block mb-2" onclick="logout()">Logout</button>
        `;
      }

      // Global functions
      window.logout = async () => {
        await auth.signOut();
        window.location.href = '../index.html';
      };

      window.closeUserMenu = () => {
        document.getElementById('user-menu').classList.remove('active');
      };

      // Event listeners
      document.getElementById('user-menu-btn').addEventListener('click', () => {
        document.getElementById('user-menu').classList.add('active');
      });

      document.getElementById('user-menu').addEventListener('click', (e) => {
        if (e.target.id === 'user-menu') {
          closeUserMenu();
        }
      });

      document.getElementById('order-modal').addEventListener('click', (e) => {
        if (e.target.id === 'order-modal') {
          closeOrderModal();
        }
      });

      document.getElementById('product-modal').addEventListener('click', (e) => {
        if (e.target.id === 'product-modal') {
          closeProductModal();
        }
      });

      // Initialize
      loadDashboardStats();
      updateAuthMenu();
    </script>
  </body>
</html>
